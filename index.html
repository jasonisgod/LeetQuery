<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
        body { text-align: center; background-color: #222; }
        h1,h2,h3,h4,h5,p,div,pre,code,a,td { font-family: "Courier New";  }
        h1,h2,h3,h4,h5,p,div,pre,code,td { color: #bbb; }
        a { color: cornflowerblue; }
        img { width: 30%; max-width: 200px; }
        p { margin: 1px; }
        div { margin: 0 20px; overflow: scroll; display: grid; }
        #bb { color: #000; border-bottom: 1px solid #ddd; line-height: 0.1em; margin: 10px 0 20px; }
        .element::-webkit-scrollbar {display:none}
        ::-webkit-scrollbar { width: 0; background: transparent; }
        td { padding: 5px 20px;  white-space: nowrap; font-size: 15px; }
        td.q { width: 10%; min-width: 100px; }
        button { border-radius: 3px; margin: 0 10px; background-color: #bbb; font-size: 15px;} 
        pre { margin: 1px; }
        code { border:#bbb solid 1px; border-radius: 15px; padding: 30px; margin: 0 30px; text-align: left;}
</style>
<link rel="stylesheet" href="./css/monokai.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
<script>
    // TODO: hljs.highlightAll() after every refresh
    $(document).ready(function(){ init(); });
    setInterval(myTimer, 5000);
    var usernameList = ['leovincentseles','seali','jasonisgod','jackycaelum','qm4zirQ15o','yoyo6245a','wubinray87'];
    // TODO: shorten 'weekly-contest-283' to 'w283'
    var contestNameList = ['weekly-contest-283', 'biweekly-contest-73']; 
    var data = {};
    function init() {
        var box = $('#box');
        contestNameList.forEach(contestName => {
            var h3 = $('<h3>').html(contestName);
            box.append(h3);
            var div = $('<div id="' + contestName + '"></div>');
            box.append(div);
        });
        myTimer();
        // contestNameList.forEach(e => {
        //     data[e] = 
        // });
    }
    function updateTables() {
        // TODO: sort rows by rank
        contestNameList.forEach(contestName => {
            console.log(contestName);
            var table = $('<table></table>');
            data[contestName].forEach(e => {
                console.log(e);
                var tr = $('<tr></tr>');
                tr.append($('<td></td>').text(e['rank']));
                tr.append($('<td></td>').text(e['username']));
                tr.append($('<td></td>').text(e['score']));
                tr.append($('<td></td>').text(e['finish_time']));
                for (var i = 1; i <= 4; i++) {
                    if (e['Q' + i]['solve_time'] == undefined) {
                        tr.append($('<td></td>'));
                        continue;
                    }
                    var id = contestName + '-' + e['username'];
                    var solve_time = e['Q' + i]['solve_time'];
                    var fail_count = e['Q' + i]['fail_count'];
                    var code = e['Q' + i]['code'];
                    var td = $('<td></td>').addClass('q');
                    var span1 = $('<span></span>').html(solve_time);
                    var onclickCmd = "showCode('"+contestName+"','"+e['username']+"','"+('Q' + i)+"')";
                    var button = $('<button><b>&#60;/&#62;</b></button>').attr("id", 'btn-' + id).attr("onclick", onclickCmd);
                    var span2 = $('<span></span>').html(fail_count);
                    // var input = $('<text></text>').attr("id", 'code-' + id).html(code).hide();
                    td.append(span1).append(button).append(span2);
                    tr.append(td);
                }
                table.append(tr);
            });
            var div = $('#' + contestName);
            console.log(contestName);
            div.html('').append(table);
        });
    }
    function showCode(contestName, username, question)
    {
        console.log(contestName, username, question);
        data[contestName].forEach(e => {
            if (e['username'] = username) {
                // console.log(e[question]['code']);
                $('#code').html(e[question]['code']);
            }
        });
    }
    function myTimer() {
        data = {}
        contestNameList.forEach(contestName => {
            data[contestName] = [];
            usernameList.forEach(username => {
                var headers = new Headers();
                headers.append('Content-Type', 'application/json');
                headers.append('Accept', 'application/json');
                var url = 'http://jasonisgod.xyz/leetquery/files/' + contestName + '-' + username + '.json';
                fetch(url, {
                    mode: 'cors',
                    credentials: 'include',
                    method: 'POST',
                    headers: headers
                }).then(response => response.json())
                    .then(json => data[contestName].push(json))
                    .catch(error => console.log(error.message));
            });
        });
        // TODO: replace by $.when(fetch1, fetch2, fetch3, ...)
        setTimeout(updateTables, 2000);
    }
</script>
<body>
        <br><br>
        <h1>LeetQuery</h1>
        <h6 id="bb">Blackbox Contest</h6>
        <p>Sponsored by Google Chen</p>
        <p>Hosted by Jason Che</p>
        <p>Premium Leader Jacky Lin</p>
        <br><br>
        <img src="https://assets.leetcode.com/users/leetcode/avatar_1568224780.png">
        <br><br>
        <div id="box"></div>
        <br><br>
        <div><pre><code id="code">
def leetquery():                                                                                                       #
    username_list = ['leovincentseles','jackycaelum','qm4zirQ15o','seali','jasonisgod','yoyo6245a','wubinray87']       #
    contest_name_list = ['weekly-contest-{i}' for i in range(1,999)]                                                   #
    query_contests(contest_name_list, username_list)                                                                   #
        </code></pre></div>
        <br><br>
        <p>#jasonisgod &copy; Copyright 2022</p>
        <br><br>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script>
</body>
